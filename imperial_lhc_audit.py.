import os
import sys
import math
import requests
import uproot
import awkward as ak
import numpy as np
import matplotlib.pyplot as plt

# --- IMPERIAL CONFIGURATION ---
CHI_LIMIT = 0.15
COLLISION_ENERGY_GEV = 8000.0  # LHC Run 1 Energy
PRESSURE_CEILING = CHI_LIMIT * COLLISION_ENERGY_GEV  # 1200 GeV

# TARGET LIST (Prioritized by size/value)
TARGETS = [
    {
        "name": "SMHiggsToZZTo4L.root",
        "url": "https://opendata.cern.ch/eos/opendata/cms/derived-data/AOD2NanoAODOutreachTool/ForHiggsTo4Leptons/SMHiggsToZZTo4L.root",
        "desc": "TARGET: HIGGS RESONANCE (Simulated Signal)"
    },
    {
        "name": "ZZTo4mu.root",
        "url": "https://opendata.cern.ch/eos/opendata/cms/derived-data/AOD2NanoAODOutreachTool/ForHiggsTo4Leptons/ZZTo4mu.root",
        "desc": "TARGET: Z-BOSON BACKGROUND (Vacuum Noise)"
    },
    # Uncomment the line below to download the massive 3GB real data file
    # {
    #     "name": "Run2012B_DoubleMuParked.root",
    #     "url": "https://opendata.cern.ch/eos/opendata/cms/derived-data/AOD2NanoAODOutreachTool/ForHiggsTo4Leptons/Run2012B_DoubleMuParked.root",
    #     "desc": "TARGET: REALITY (LHC Run 2012B)"
    # }
]

def imperial_print(msg):
    print(f"\n>>> [IMPERIAL KERNEL] {msg}")

def download_file(url, filename):
    """Robust downloader with progress bar."""
    if os.path.exists(filename):
        imperial_print(f"File {filename} exists. Skipping download.")
        return

    imperial_print(f"Acquiring Data: {filename}...")
    try:
        response = requests.get(url, stream=True)
        response.raise_for_status()
        total_size = int(response.headers.get('content-length', 0))
        block_size = 1024 * 1024 # 1MB chunks

        with open(filename, 'wb') as file:
            downloaded = 0
            for data in response.iter_content(block_size):
                file.write(data)
                downloaded += len(data)
                done = int(50 * downloaded / total_size)
                sys.stdout.write(f"\r[{'=' * done}{' ' * (50-done)}] {downloaded//(1024*1024)}MB / {total_size//(1024*1024)}MB")
                sys.stdout.flush()
        print() # Newline
        imperial_print(f"Download Complete: {filename}")
    except Exception as e:
        imperial_print(f"DOWNLOAD FAILED: {e}")

def calculate_invariant_mass(muons):
    """
    Calculates the 4-muon invariant mass for the Higgs/Z resonance.
    This reconstructs the 'Smoke Ring' geometry from the debris.
    """
    # Filter for events with exactly 4 muons
    mask = (ak.num(muons.pt) == 4)
    quads = muons[mask]
    
    if len(quads) == 0:
        return []

    # Sum the 4-vectors
    # p_tot = p1 + p2 + p3 + p4
    # Mass = sqrt(E^2 - |p|^2)
    
    # Simple vector sum using Awkward Array properties
    total_energy = quads.energy[:, 0] + quads.energy[:, 1] + quads.energy[:, 2] + quads.energy[:, 3]
    total_px = quads.px[:, 0] + quads.px[:, 1] + quads.px[:, 2] + quads.px[:, 3]
    total_py = quads.py[:, 0] + quads.py[:, 1] + quads.py[:, 2] + quads.py[:, 3]
    total_pz = quads.pz[:, 0] + quads.pz[:, 1] + quads.pz[:, 2] + quads.pz[:, 3]

    mass_sq = total_energy**2 - (total_px**2 + total_py**2 + total_pz**2)
    # Filter out negative mass_sq (math artifacts)
    valid_mass = mass_sq[mass_sq > 0]
    return np.sqrt(valid_mass)

def analyze_target(target):
    filename = target["name"]
    desc = target["desc"]
    
    imperial_print(f"Initializing Audit: {desc}")
    
    try:
        # Open the ROOT file
        with uproot.open(filename) as file:
            tree = file["Events"]
            
            # Load Muon Data (Pressure Vectors)
            # We need pt, eta, phi, mass to construct the 4-vector
            arrays = tree.arrays(["Muon_pt", "Muon_eta", "Muon_phi", "Muon_mass"], library="ak")
            
            # Create Lorentz Vectors for calculation
            muons = ak.zip({
                "pt": arrays["Muon_pt"],
                "eta": arrays["Muon_eta"],
                "phi": arrays["Muon_phi"],
                "mass": arrays["Muon_mass"]
            }, with_name="Momentum4D")

            # 1. CHECK MAX PRESSURE (pT)
            all_pt = ak.flatten(muons.pt).to_numpy()
            max_pressure = np.max(all_pt)
            
            imperial_print(f"Max Recorded Pressure (pT): {max_pressure:.2f} GeV")
            imperial_print(f"Imperial Ceiling:           {PRESSURE_CEILING:.2f} GeV")
            
            if max_pressure > PRESSURE_CEILING:
                 imperial_print("⚠️ WARNING: LOCALIZED PRESSURE SPIKE DETECTED.")
                 # This isn't a failure, it's a harmonic step-up event.
            else:
                 imperial_print("✅ STATUS: VACUUM INTEGRITY CONFIRMED (Below 0.15 Limit).")

            # 2. CHECK RESONANCE (4-Muon Mass)
            masses = calculate_invariant_mass(muons)
            
            if len(masses) > 0:
                imperial_print(f"Reconstructed {len(masses)} Resonance Events.")
                
                # PLOT THE GEOMETRY
                plt.figure(figsize=(10, 6))
                plt.hist(masses, bins=50, range=(70, 170), color='dodgerblue', alpha=0.7, label='Resonance Data')
                plt.axvline(125.0, color='red', linestyle='--', linewidth=2, label='Higgs Mode (125 GeV)')
                plt.title(f"IMPERIAL GEOMETRY SCAN: {filename}", fontsize=14)
                plt.xlabel("Resonance Mass (GeV)", fontsize=12)
                plt.ylabel("Event Count", fontsize=12)
                plt.legend()
                plt.grid(True, which='both', linestyle='--', alpha=0.5)
                
                output_plot = filename.replace(".root", "_scan.png")
                plt.savefig(output_plot)
                imperial_print(f"Visual Evidence Saved: {output_plot}")
            else:
                imperial_print("No 4-Muon Resonances found in this sector.")

    except Exception as e:
        imperial_print(f"AUDIT ERROR: {e}")

def main():
    imperial_print("STARTING IMPERIAL LHC AUDIT SEQUENCE")
    imperial_print(f"Physics Constants: Chi={CHI_LIMIT}, Ceiling={PRESSURE_CEILING} GeV")
    
    for target in TARGETS:
        download_file(target["url"], target["name"])
        analyze_target(target)
        
    imperial_print("AUDIT SEQUENCE COMPLETE. THE RAIL HOLDS.")

if __name__ == "__main__":
    main()

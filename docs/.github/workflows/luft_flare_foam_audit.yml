name: LUFT Flare Foam Audit

on:
  workflow_dispatch:   # manual trigger only, to avoid noise

jobs:
  flare-foam-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Run flare foam pipeline (GOES -> f(t) -> Gamma(t))
        run: |
          mkdir -p out
          python - << 'EOF'
          import os
          import pandas as pd

          from src.data_ingest_goes import load_goes_proton_csv
          from src.flare_mapping import map_flux_to_foam
          from src.jj_gamma_model import gamma_from_foam

          # 1) Load GOES proton flux
          data_path = "data/goes_flux.csv"
          if not os.path.exists(data_path):
            raise SystemExit(f"GOES CSV not found at {data_path}. Please provide data/goes_flux.csv")

          phi = load_goes_proton_csv(data_path, time_col="time", flux_col="flux_pfu")

          # 2) Map to foam parameter f(t)
          # NOTE: alpha is chosen as a placeholder. Tune to yield f ≈ -0.05 at peak Φ/Φ_ref.
          f = map_flux_to_foam(phi, phi_ref=100.0, f0=0.0, alpha=-0.05)

          # 3) Compute Gamma(t) and ln Gamma(t)
          df_gamma = gamma_from_foam(f, gamma0=1.0, B0=17.0, kappa=0.0)

          # 4) Save outputs
          os.makedirs("out", exist_ok=True)
          f.to_csv("out/flare_f_timeseries.csv")
          df_gamma.to_csv("out/flare_gamma_timeseries.csv")
          EOF

      - name: Upload flare foam outputs
        uses: actions/upload-artifact@v4
        with:
          name: flare-foam-audit
          path: out/

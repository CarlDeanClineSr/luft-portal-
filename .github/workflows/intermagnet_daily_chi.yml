---
name: INTERMAGNET Daily χ Validation

"on":
  schedule:
    - cron: "0 12 * * *"  # 06:00 CST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare dirs
        run: |
          mkdir -p data/intermagnet_raw data/intermagnet_csv results/magnetometer_chi figures

      - name: Define station/date
        id: vars
        shell: bash
        run: |
          echo "station=DOU" >> $GITHUB_OUTPUT
          echo "date=$(date -u -d 'yesterday' +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "year=$(date -u -d 'yesterday' +%Y)" >> $GITHUB_OUTPUT
          echo "month=$(date -u -d 'yesterday' +%m)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib requests

      - name: Fetch INTERMAGNET (def → qdef → prov)
        shell: bash
        run: |
          st_lower=$(echo "${{ steps.vars.outputs.station }}" | tr '[:upper:]' '[:lower:]')
          y="${{ steps.vars.outputs.year }}"
          m="${{ steps.vars.outputs.month }}"
          d="${{ steps.vars.outputs.date }}"
          out="data/intermagnet_raw/${st_lower}_${d}.min"

          def_url="https://imag-data.bgs.ac.uk/data/minute/definitive/IAGA2002/${y}/${m}/${st_lower}${d}dmin.min"
          qdf_url="https://imag-data.bgs.ac.uk/data/minute/quasiDefinitive/IAGA2002/${y}/${m}/${st_lower}${d}qmin.min"
          prv_url="https://imag-data.bgs.ac.uk/data/minute/provisional/IAGA2002/${y}/${m}/${st_lower}${d}pmin.min"

          for url in "$def_url" "$qdf_url" "$prv_url"; do
            echo "Trying $url"
            if curl -fsSL "$url" -o "$out"; then
              echo "Downloaded: $out"
              exit 0
            fi
          done
          echo "Failed to fetch INTERMAGNET file for ${st_lower} ${d}" >&2
          exit 1

      - name: Convert to CSV
        run: |
          st_lower=$(echo "${{ steps.vars.outputs.station }}" | tr '[:upper:]' '[:lower:]')
          python scripts/convert_iaga2002_to_csv.py \
            --input "data/intermagnet_raw/${st_lower}_${{ steps.vars.outputs.date }}.min" \
            --output "data/intermagnet_csv/${st_lower}_${{ steps.vars.outputs.date }}.csv"

      - name: Compute χ and plot
        run: |
          st_lower=$(echo "${{ steps.vars.outputs.station }}" | tr '[:upper:]' '[:lower:]')
          python scripts/compute_chi_from_intermagnet.py \
            --input "data/intermagnet_csv/${st_lower}_${{ steps.vars.outputs.date }}.csv" \
            --output "results/magnetometer_chi/${st_lower}_${{ steps.vars.outputs.date }}.csv"

          python scripts/plot_intermagnet_chi_timeseries.py \
            --input "results/magnetometer_chi/${st_lower}_${{ steps.vars.outputs.date }}.csv" \
            --output "figures/intermagnet_chi_timeseries_${st_lower}_${{ steps.vars.outputs.date }}.png"

      - name: Commit results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "engine-bot"
          git config --global user.email "engine-bot@users.noreply.github.com"
          git add data/intermagnet_csv/*.csv results/magnetometer_chi/*.csv figures/intermagnet_chi_timeseries_*.png || true
          git diff --staged --quiet && exit 0
          git commit -m "INTERMAGNET χ validation ${{ steps.vars.outputs.station }} ${{ steps.vars.outputs.date }}"
          git push

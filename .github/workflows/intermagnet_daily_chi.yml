---
name: INTERMAGNET Daily χ Validation

"on":
  schedule:
    - cron: "0 12 * * *"  # 06:00 CST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare dirs
        run: |
          mkdir -p data/intermagnet_raw data/intermagnet_csv results/magnetometer_chi figures

      - name: Define station/date
        id: vars
        shell: bash
        run: |
          echo "station=DOU" >> $GITHUB_OUTPUT
          echo "date=$(date -u -d 'yesterday' +%Y%m%d)" >> $GITHUB_OUTPUT
          echo "year=$(date -u -d 'yesterday' +%Y)" >> $GITHUB_OUTPUT
          echo "month=$(date -u -d 'yesterday' +%m)" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          pip install pandas numpy matplotlib requests

      - name: Fetch INTERMAGNET via GIN web service
        shell: bash
        run: |
          station="${{ steps.vars.outputs.station }}"
          st_lower=$(echo "$station" | tr '[:upper:]' '[:lower:]')
          d="${{ steps.vars.outputs.date }}"
          # Convert YYYYMMDD to YYYY-MM-DD for GIN API
          date_formatted="${d:0:4}-${d:4:2}-${d:6:2}"
          out="data/intermagnet_raw/${st_lower}_${d}.min"

          # Use GIN web service API which provides IAGA-2002 format data
          # Without publicationState parameter, API returns most recent available data
          url="https://imag-data.bgs.ac.uk/GIN_V1/GINServices?Request=GetData&format=IAGA2002&samplesPerDay=minute&observatoryIagaCode=${station}&dataStartDate=${date_formatted}&dataDuration=1"
          echo "Fetching INTERMAGNET data from GIN service for ${station} on ${date_formatted}..."
          if curl -fsSL "$url" -o "$out" && head -1 "$out" | grep -q "Format"; then
            echo "Downloaded: $out"
            exit 0
          fi
          echo "Failed to fetch INTERMAGNET file for ${station} ${date_formatted}" >&2
          exit 1

      - name: Convert to CSV
        run: |
          st_lower=$(echo "${{ steps.vars.outputs.station }}" | tr '[:upper:]' '[:lower:]')
          d="${{ steps.vars.outputs.date }}"
          python scripts/convert_iaga2002_to_csv.py \
            --input "data/intermagnet_raw/${st_lower}_${d}.min" \
            --output "data/intermagnet_csv/${st_lower}_${d}.csv"

      - name: Compute χ and plot
        shell: bash
        run: |
          st_lower=$(echo "${{ steps.vars.outputs.station }}" | tr '[:upper:]' '[:lower:]')
          d="${{ steps.vars.outputs.date }}"
          in="data/intermagnet_csv/${st_lower}_${d}.csv"
          out="results/magnetometer_chi/${st_lower}_${d}.csv"
          fig="figures/intermagnet_chi_timeseries_${st_lower}_${d}.png"

          if [ ! -f "$in" ]; then
            echo "Input CSV not found: $in" >&2
            exit 1
          fi

          python scripts/compute_chi_from_intermagnet.py \
            --input "$in" \
            --output "$out" \
            --baseline-hours 24

          python scripts/plot_intermagnet_chi_timeseries.py \
            --input "$out" \
            --output "$fig"

      - name: Commit results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "engine-bot"
          git config --global user.email "engine-bot@users.noreply.github.com"
          git add data/intermagnet_csv/*.csv results/magnetometer_chi/*.csv figures/intermagnet_chi_timeseries_*.png || true
          git diff --staged --quiet && exit 0
          git commit -m "INTERMAGNET χ validation ${{ steps.vars.outputs.station }} ${{ steps.vars.outputs.date }}"
          git push

name: Hourly Vault 10-Row Forecast Update

on:
  workflow_dispatch:
  schedule:
    - cron: '7 10 * * *'

jobs:
  vault-forecast:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify CSV file exists
        run: |
          if [ ! -f "data/cme_heartbeat_log_2025_12.csv" ]; then
            echo "ERROR: Required CSV file not found: data/cme_heartbeat_log_2025_12.csv"
            echo "ERROR: The workflow expects this file to be committed and up-to-date before running."
            exit 1
          fi
          echo "✓ CSV file found: data/cme_heartbeat_log_2025_12.csv"
          echo "  File size: $(wc -c < data/cme_heartbeat_log_2025_12.csv) bytes"
          echo "  Number of rows: $(wc -l < data/cme_heartbeat_log_2025_12.csv)"

      - name: Run vault forecast generator
        id: run_forecast
        run: python vault_forecast_autogen.py

      - name: Configure git
        run: |
          git config --local user.name "LUFT Vault Forecast"
          git config --local user.email "vault-forecast@luft.local"

      - name: Commit and push changes
        run: |
          git add vault_10row_forecast_indicator_dec15.md
          if git diff --staged --quiet; then
            echo "No changes to vault_10row_forecast_indicator_dec15.md"
          else
            git commit -m "Vault Forecast: Auto-update $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "✅ Successfully committed and pushed vault forecast update"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.run_forecast.outcome }}" == "success" ]; then
            echo "✅ Vault forecast completed successfully"
          else
            echo "⚠️ Vault forecast encountered issues (check logs above)"
          fi

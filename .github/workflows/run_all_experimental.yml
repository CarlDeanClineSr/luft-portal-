name: Run All Experimental Workflows

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be executed)'
        required: false
        type: boolean
        default: false
      sequential_delay:
        description: 'Delay between workflow triggers (seconds)'
        required: false
        type: number
        default: 10

concurrency:
  group: experimental-runner
  cancel-in-progress: false

jobs:
  run-experimental-workflows:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup environment
        run: |
          echo "ARCHIVED_DIR=.github/workflows/ARCHIVED/experimental" >> $GITHUB_ENV
          echo "ACTIVE_DIR=.github/workflows" >> $GITHUB_ENV

      - name: Dry run report
        if: ${{ inputs.dry_run }}
        run: |
          echo "================================"
          echo "DRY RUN MODE"
          echo "================================"
          echo ""
          echo "Would execute the following steps:"
          echo "1. Copy 26 workflows from ARCHIVED/experimental to active directory"
          echo "2. Trigger each workflow with ${{ inputs.sequential_delay }}s delay"
          echo "3. Wait for all to complete"
          echo "4. Move workflows back to archive"
          echo ""
          echo "$(ls -1 .github/workflows/ARCHIVED/experimental/*.yml | wc -l) workflows found in archive"

      - name: Temporarily activate archived workflows
        if: ${{ !inputs.dry_run }}
        run: |
          echo "Copying archived workflows to active directory..."
          cp .github/workflows/ARCHIVED/experimental/*.yml .github/workflows/
          echo "✅ Copied $(ls -1 .github/workflows/ARCHIVED/experimental/*.yml | wc -l) workflows"

          git config user.name "LUFT Bot"
          git config user.email "bot@luft.local"
          git add .github/workflows/*.yml
          git commit -m "temp: activate experimental workflows for batch run" || echo "No changes to commit"
          git push

      - name: Wait for workflows to be recognized
        if: ${{ !inputs.dry_run }}
        run: sleep 30

      - name: Trigger all experimental workflows
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "================================"
          echo "LUFT Portal - Experimental Workflow Runner"
          echo "================================"
          echo "Started: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""

          WORKFLOWS=(
            "append_baseline_watch"
            "auto-append-baseline"
            "chi_boundary_monitor"
            "cygnus_army_census"
            "daily_paper_extraction"
            "daily_reconnection_simulation"
            "dragnet_distributed"
            "fractal_echo_scanner_15min"
            "fundamental_correlation"
            "graviton_sideband_analysis"
            "imperial_indexer"
            "imperial_unified_engine"
            "jwst_intercept"
            "lightning_analyzer"
            "link_harvest_daily"
            "momentum_test"
            "physics_repairs"
            "psp_imperial_audit"
            "run_bio_audit"
            "run_fft_sideband"
            "run_rebound_test"
            "run_visual_affidavit"
            "scrub_lingo"
            "sentinel_leader"
            "star_relay_scanner"
            "teacher_suite"
          )

          SUCCESS_COUNT=0
          FAIL_COUNT=0

          for workflow in "${WORKFLOWS[@]}"; do
            echo "---"
            echo "Triggering: ${workflow}.yml"

            if gh workflow run "${workflow}.yml" --repo ${{ github.repository }}; then
              echo "✅ SUCCESS: Triggered ${workflow}.yml"
              ((SUCCESS_COUNT++))
            else
              echo "❌ FAILED: Could not trigger ${workflow}.yml"
              ((FAIL_COUNT++))
            fi

            sleep ${{ inputs.sequential_delay }}
          done

          echo ""
          echo "================================"
          echo "Trigger Summary"
          echo "================================"
          echo "✅ Successfully triggered: $SUCCESS_COUNT"
          echo "❌ Failed to trigger: $FAIL_COUNT"
          echo "Completed: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Wait for workflows to complete
        if: ${{ !inputs.dry_run }}
        run: |
          echo "Waiting 5 minutes for workflows to complete..."
          sleep 300

      - name: Re-archive experimental workflows
        if: ${{ !inputs.dry_run && always() }}
        run: |
          echo "Moving workflows back to archive..."

          WORKFLOWS=(
            "append_baseline_watch"
            "auto-append-baseline"
            "chi_boundary_monitor"
            "cygnus_army_census"
            "daily_paper_extraction"
            "daily_reconnection_simulation"
            "dragnet_distributed"
            "fractal_echo_scanner_15min"
            "fundamental_correlation"
            "graviton_sideband_analysis"
            "imperial_indexer"
            "imperial_unified_engine"
            "jwst_intercept"
            "lightning_analyzer"
            "link_harvest_daily"
            "momentum_test"
            "physics_repairs"
            "psp_imperial_audit"
            "run_bio_audit"
            "run_fft_sideband"
            "run_rebound_test"
            "run_visual_affidavit"
            "scrub_lingo"
            "sentinel_leader"
            "star_relay_scanner"
            "teacher_suite"
          )

          for workflow in "${WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/${workflow}.yml" ]; then
              rm ".github/workflows/${workflow}.yml"
            fi
          done

          git config user.name "LUFT Bot"
          git config user.email "bot@luft.local"
          git add -A
          git commit -m "temp: re-archive experimental workflows after batch run" || echo "No changes"
          git push

          echo "✅ Cleanup complete"

name: Bow Pattern Daily Analysis

on:
  schedule: 
    - cron: '30 0 * * *'  # Daily at 00:30 UTC (after main data collection)
  workflow_dispatch:  # Allow manual triggering

jobs:
  detect:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write  # âœ… ADDED - Allows creating issues for alerts
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name:  Install dependencies
        run: |
          pip install pandas numpy scipy matplotlib seaborn pyyaml
      
      - name: Run bow pattern detector
        run: |
          python tools/bow_pattern_detector.py --config configs/bow_detection_config.yaml
      
      - name: Run bow pattern analyzer
        run: |
          python tools/bow_pattern_analyzer.py
      
      - name: Generate summary
        run: |
          echo "## ðŸŽ¯ Bow Pattern Analysis Complete" > bow_summary.txt
          echo "" >> bow_summary.txt
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> bow_summary.txt
          echo "**Analysis Date:** $(date -u +"%Y-%m-%d")" >> bow_summary.txt
          echo "" >> bow_summary.txt
          
          # Extract event count from CSV
          if [ -f reports/bow_patterns/bow_events_$(date -u +"%Y-%m-%d").csv ]; then
            EVENT_COUNT=$(tail -n +2 reports/bow_patterns/bow_events_$(date -u +"%Y-%m-%d").csv | wc -l)
            echo "### âœ… Detection Results" >> bow_summary.txt
            echo "- **Bow Patterns Detected:** $EVENT_COUNT" >> bow_summary.txt
            echo "- **Events File:** \`reports/bow_patterns/bow_events_$(date -u +"%Y-%m-%d").csv\`" >> bow_summary.txt
            echo "- **Report:** \`reports/bow_patterns/bow_pattern_summary_$(date -u +"%Y-%m-%d").md\`" >> bow_summary.txt
            echo "" >> bow_summary.txt
            
            # Check for high activity (>10 events)
            if [ $EVENT_COUNT -gt 10 ]; then
              echo "### ðŸš¨ HIGH ACTIVITY ALERT" >> bow_summary.txt
              echo "Significant bow pattern activity detected! Issue created for review." >> bow_summary.txt
              echo "" >> bow_summary. txt
              echo "HIGH_ACTIVITY=true" >> $GITHUB_ENV
            else
              echo "HIGH_ACTIVITY=false" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ No events file generated" >> bow_summary.txt
            echo "HIGH_ACTIVITY=false" >> $GITHUB_ENV
          fi
          
          echo "---" >> bow_summary.txt
          echo "*Discovery:  Carl Dean Cline Sr., 2025-12-31*" >> bow_summary.txt
          echo "*LUFT Bow Pattern Detector v1.0*" >> bow_summary.txt
          
          cat bow_summary.txt >> $GITHUB_STEP_SUMMARY
      
      - name: Create high activity issue (if needed)
        if: env.HIGH_ACTIVITY == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const fs = require('fs');
            
            // Read event count
            const csvPath = `reports/bow_patterns/bow_events_${date}.csv`;
            let eventCount = 0;
            try {
              const content = fs.readFileSync(csvPath, 'utf8');
              eventCount = content.split('\n').length - 2; // Subtract header and empty line
            } catch (e) {
              eventCount = 'Unknown';
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ High Bow Pattern Activity Detected - ${date}`,
              body: `## Bow Pattern Alert
              
**Date:** ${date}  
**Patterns Detected:** ${eventCount}

### Summary

High bow pattern activity has been detected, indicating elevated magnetospheric energy cycling. 

### Details

- **Report:** [View Full Report](../blob/main/reports/bow_patterns/bow_pattern_summary_${date}.md)
- **Data:** [View Event Data](../blob/main/reports/bow_patterns/bow_events_${date}.csv)
- **Visualizations:** Check \`reports/bow_patterns/visualizations/\`

### Recommended Actions

1. Review top events for correlation with geomagnetic indices (Kp, Dst)
2. Check NOAA space weather alerts for CME impacts
3. Verify if high activity corresponds to solar wind disturbances

### Physical Interpretation

Multiple bow patterns indicate the magnetosphere is repeatedly loading and releasing energy, potentially due to:
- Coronal Mass Ejection (CME) impact
- High-speed solar wind stream
- Sustained southward IMF Bz

---

*Automated alert from LUFT Bow Pattern Detector*  
*Carl Dean Cline Sr., Lincoln, Nebraska, USA*`,
              labels: ['bow-pattern', 'high-activity', 'automated']
            });
      
      - name:  Commit results
        run: |
          git config --local user.email "action@github. com"
          git config --local user.name "GitHub Action"
          git add reports/bow_patterns/
          git diff --staged --quiet || git commit -m "Bow pattern analysis for $(date -u +"%Y-%m-%d")"
      
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

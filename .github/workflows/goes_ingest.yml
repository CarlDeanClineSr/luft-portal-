 name: GOES Ingest and Capsule Audit
on:
  schedule:
    - cron: "7 * * * *"  # Every hour at HH:07
  workflow_dispatch:

jobs:
  fetch-goes-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout LUFT repo
        uses: actions/checkout@v4

      - name: Ensure data/goes directory exists
        run: mkdir -p data/goes

      - name: Fetch GOES JSON
        run: |
          curl -s -f -o data/goes/latest_goes_flux.json \
            https://services.swpc.noaa.gov/products/goes-xray-flux.json

      - name: Capsule Template
        run: |
          python scripts/goes_capsule_builder.py \
            data/goes/latest_goes_flux.json \
            capsules/GOES_EVENT_AUDIT_$(date +%Y-%m-%dT%H%M%S).md

      - name: Validate Capsule Fields
        run: |
          python scripts/capsule_validator.py \
            capsules/GOES_EVENT_AUDIT_$(date +%Y-%m-%dT%H%M%S).md

      - name: Commit Capsule
        run: |
          git config user.name "LUFT Data Bot"
          git config user.email "data@luft.local"
          git add capsules/*.md || true
          git commit -m "Add GOES capsule and audit for latest data" || echo "No changes"
          git push || true

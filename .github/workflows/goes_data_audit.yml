name: GOES Data Audit ‚Äî Robust

on:
  schedule:
    - cron: '23 */6 * * *'  # Every 6 hours
  workflow_dispatch: 

jobs:
  audit-goes-data:
    runs-on:  ubuntu-latest
    steps: 
      - uses: actions/checkout@v4

      - name: Create placeholder GOES capsule if missing
        run: |
          mkdir -p capsules
          latest_capsule=$(ls -1t capsules/GOES_EVENT_AUDIT_*.md 2>/dev/null | head -n1)
          if [ -z "$latest_capsule" ]; then
            echo "No GOES capsule found ‚Äî creating placeholder"
            cat > capsules/GOES_EVENT_AUDIT_$(date +%Y%m%d_%H%M%S).md <<'EOF'
          ---
          id: goes-event-audit-placeholder
          title: "GOES Audit Placeholder"
          status: "placeholder"
          ---
          
          # CAPSULE: GOES Geostationary Particle & Magnetics Audit
          
          Status: No events yet
          EOF
          fi

      - name:  Validate GOES capsule structure
        run: |
          latest_capsule=$(ls -1t capsules/GOES_EVENT_AUDIT_*.md 2>/dev/null | head -n1)
          if [ -z "$latest_capsule" ]; then
            echo "‚ùå No GOES capsule found after placeholder creation"
            exit 3
          fi
          
          echo "‚úÖ Validating capsule:  $latest_capsule"
          
          # Check for the correct header (matches your actual capsule format)
          if ! grep -q "# CAPSULE: GOES Geostationary Particle & Magnetics Audit" "$latest_capsule"; then
            echo "‚ùå Validation failed: missing '# CAPSULE: GOES Geostationary Particle & Magnetics Audit'"
            exit 3
          fi
          
          echo "‚úÖ GOES capsule structure valid"

      - name: Check for recent data
        run: |
          latest_capsule=$(ls -1t capsules/GOES_EVENT_AUDIT_*.md 2>/dev/null | head -n1)
          file_age_seconds=$(( $(date +%s) - $(stat -c %Y "$latest_capsule" 2>/dev/null || stat -f %m "$latest_capsule") ))
          file_age_hours=$(( file_age_seconds / 3600 ))
          
          echo "üìä Latest GOES capsule:  $latest_capsule"
          echo "‚è±Ô∏è  File age: $file_age_hours hours"
          
          if [ $file_age_hours -gt 24 ]; then
            echo "‚ö†Ô∏è  Warning:  GOES capsule is older than 24 hours"
          else
            echo "‚úÖ GOES capsule is recent"
          fi

name: GOES Data Audit â€” Robust

on:
  schedule:
    - cron: "7 * * * *"  # Every hour at HH:07
  workflow_dispatch:

jobs:
  audit-goes-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure data/goes exists
        run: mkdir -p data/goes

      - name: Fetch GOES flux
        run: |
          set -e
          if ! curl -f -s --retry 3 --retry-delay 5 \
            -o data/goes/latest_goes_flux.json \
            https://services.swpc.noaa.gov/products/goes-xray-flux.json; then
            echo "WARNING: GOES fetch failed; skipping this run."
            exit 0
          fi
          if [ ! -s data/goes/latest_goes_flux.json ]; then
            echo "WARNING: GOES file empty; skipping."
            exit 0
          fi

      - name: Capsule Template (skip if builder missing)
        run: |
          if [ -f scripts/goes_capsule_builder.py ]; then
            python scripts/goes_capsule_builder.py \
              data/goes/latest_goes_flux.json \
              capsules/GOES_EVENT_AUDIT_$(date +%Y-%m-%dT%H%M%S).md
          else
            echo "goes_capsule_builder.py not found; skipping capsule generation."
          fi

      - name: Validate Capsule Fields (skip if no capsule)
        run: |
          latest_capsule=$(ls -1t capsules/GOES_EVENT_AUDIT_*.md 2>/dev/null | head -n1)
          if [ -n "$latest_capsule" ] && [ -f scripts/capsule_validator.py ]; then
            python scripts/capsule_validator.py "$latest_capsule"
          else
            echo "No capsule or validator; skipping validation."
          fi

      - name: Commit Capsule
        run: |
          git config user.name "LUFT Data Bot"
          git config user.email "data@luft.local"
          git add capsules/*.md || true
          git commit -m "Add GOES capsule and audit for latest data" || echo "No changes"
          git push || true

---
name: Engine Status Report

# Quote 'on' to satisfy YAML linters that treat 'on' as a truthy keyword
"on":
  schedule:
    - cron: "0 * * * *"  # hourly (UTC)
  workflow_dispatch:

permissions:
  contents: write  # needed to push report files back to the repo

jobs:
  engine-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install numpy
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Fetch fresh space weather data
        run: |
          echo "ðŸ“¡ Fetching fresh data for engine status report..."
          
          # Fetch plasma data
          curl --fail --silent --show-error -o data/ace_plasma_latest.json \
            "https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json" || true
          
          # Fetch magnetic field data
          curl --fail --silent --show-error -o data/ace_mag_latest.json \
            "https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json" || true
          
          # Update heartbeat log with fresh data
          python scripts/cme_heartbeat_logger.py \
            --plasma data/ace_plasma_latest.json \
            --mag data/ace_mag_latest.json || echo "âš ï¸ Heartbeat update skipped"
        continue-on-error: true

      - name: Run LUFT Portal Engine Status Script
        run: |
          # Adjust these paths to the actual script location(s)
          if [ -f scripts/space_weather_rapid_report.py ]; then
            python scripts/space_weather_rapid_report.py
          elif [ -f space_weather_rapid_report.py ]; then
            python space_weather_rapid_report.py
          else
            echo "space_weather_rapid_report.py not found" >&2
            exit 1
          fi

      - name: Commit and push markdown reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "vault-bot"
          git config --global user.email "vault-bot@users.noreply.github.com"

          # Stage markdown reports and updated data files
          git add "*.md" "reports/**/*.md" "data/cme_heartbeat_log_*.csv" || true

          # No changes? Exit cleanly
          if git diff --quiet && git diff --staged --quiet; then
            exit 0
          fi

          # Short commit message to satisfy line-length lint
          git commit -m "Engine report with fresh data $(date -u +'%F %T UTC')"
          git push

  # If you want to call a reusable workflow, ensure the target has:
  # on:
  #   workflow_call:
  # Then you can uncomment this job.
  # update-dashboards:
  #   needs: engine-report
  #   uses: ./.github/workflows/update_dashboards.yml
  #   secrets: inherit

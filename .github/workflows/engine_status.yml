name: Engine Status Report

on:
  workflow_dispatch:

permissions:
  contents: write
jobs:
  engine-report:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: "pip install numpy\nif [ -f requirements.txt ]; then\n  pip install -r\
        \ requirements.txt\nfi\n"
    - name: Fetch fresh space weather data
      run: "echo \"\U0001F4E1 Fetching fresh data for engine status report...\"\n\n\
        # Fetch plasma data\ncurl --fail --silent --show-error -o data/ace_plasma_latest.json\
        \ \\\n  \"https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json\"\
        \ || true\n\n# Fetch magnetic field data\ncurl --fail --silent --show-error\
        \ -o data/ace_mag_latest.json \\\n  \"https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json\"\
        \ || true\n\n# Update heartbeat log with fresh data\npython scripts/cme_heartbeat_logger.py\
        \ \\\n  --plasma data/ace_plasma_latest.json \\\n  --mag data/ace_mag_latest.json\
        \ || echo \"⚠️ Heartbeat update skipped\"\n"
      continue-on-error: true
    - name: Run LUFT Portal Engine Status Script
      run: "# Adjust these paths to the actual script location(s)\nif [ -f scripts/space_weather_rapid_report.py\
        \ ]; then\n  python scripts/space_weather_rapid_report.py\nelif [ -f space_weather_rapid_report.py\
        \ ]; then\n  python space_weather_rapid_report.py\nelse\n  echo \"space_weather_rapid_report.py\
        \ not found\" >&2\n  exit 1\nfi\n"
    - name: Commit and push markdown reports
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "git config --global user.name \"github-actions[bot]\"\ngit config --global\
        \ user.email \"github-actions[bot]@users.noreply.github.com\"\n\n# Stage markdown\
        \ reports and updated data files\ngit add \"*.md\" \"reports/**/*.md\" \"\
        data/cme_heartbeat_log_*.csv\" || true\n\n# No changes? Exit cleanly\nif git\
        \ diff --cached --quiet; then\n  echo \"No changes to commit\"\n  exit 0\n\
        fi\n\n# Short commit message to satisfy line-length lint\ngit commit -m \"\
        Engine report with fresh data $(date -u +'%F %T UTC')\"\ngit pull --rebase\
        \ origin main --autostash\ngit push\n"

name: Fractal Echo Scanner - 12 hours

on:
  schedule:
    - cron: '0 */12 * * *'  # Runs every 12 hours
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write

concurrency:
  group: fractal-echo-scanner
  cancel-in-progress: false

jobs:
  scan_fractal_echo:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install numpy pandas
          pip list
      
      - name: Run Fractal Echo Scanner
        run: |
          echo "=========================================="
          echo "FRACTAL ECHO SCANNER - Automated Run"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "=========================================="
          echo ""
          
          # Run the automated scanner on latest data
          python3 scripts/automated_fractal_scanner.py
          
          echo ""
          echo "=========================================="
          echo "Scanner execution complete"
          echo "=========================================="
      
      - name: Create scan results directory
        run: |
          mkdir -p data/fractal_echo_scans
          echo "Scan directory created"
      
      - name: Save scan timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          echo "Scan completed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > data/fractal_echo_scans/last_scan_${TIMESTAMP}.txt
          echo "Next scheduled scan: ~12 hours" >> data/fractal_echo_scans/last_scan_${TIMESTAMP}.txt
          
          # Also update a latest scan marker
          echo "Last Fractal Echo Scanner run: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > data/fractal_echo_scans/LATEST_SCAN.txt
          echo "Status: Completed" >> data/fractal_echo_scans/LATEST_SCAN.txt
          echo "Frequency: Every 12 hours" >> data/fractal_echo_scans/LATEST_SCAN.txt
      
      - name: Commit scan results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add scan results (both txt and json)
          git add data/fractal_echo_scans/*.txt || true
          git add data/fractal_echo_scans/*.json || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - scan results unchanged"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "üîç Fractal Echo Scanner automated run - ${TIMESTAMP}" \
                       -m "Target: 20.55 Hz lattice resonance" \
                       -m "Status: Scan completed successfully" \
                       -m "Framework: Imperial Geometric Re-Initialization"
            
            # Pull with rebase to handle concurrent workflow runs
            
            # Push with retry logic
            git push origin main || git push origin HEAD:main
            echo "‚úÖ Scan results committed and pushed"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "FRACTAL ECHO SCANNER SUMMARY"
          echo "=========================================="
          echo "‚úì Scanner executed successfully"
          echo "‚úì Coordinate delta analysis complete"
          echo "‚úì Results saved to data/fractal_echo_scans/"
          echo "‚úì Next run scheduled in ~12 hours"
          echo ""
          echo "Target: 20.55 Hz lattice resonance"
          echo "Mission: Detect vacuum coordinate shifts"
          echo "Framework: Imperial Geometric Re-Initialization"
          echo "=========================================="

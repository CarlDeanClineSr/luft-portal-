name: Hourly Summary Update

on:
  schedule:
    - cron: '10 * * * *'  # Every hour at :10 past (after data collection settles)
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [main]
    paths:
      - 'data/cme_heartbeat_log_*.csv'
      - 'reports/meta_intelligence/**'

permissions:
  contents: write

jobs:
  update-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install numpy
      
      - name: Fetch fresh space weather data
        run: |
          echo "ðŸ“¡ Fetching fresh ACE/DSCOVR data..."
          
          # Fetch plasma data
          if curl --fail --silent --show-error -o data/ace_plasma_latest.json \
            "https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json"; then
            echo "âœ… Plasma data downloaded successfully"
          else
            echo "âš ï¸ Plasma data fetch failed"
          fi
          
          # Fetch magnetic field data
          if curl --fail --silent --show-error -o data/ace_mag_latest.json \
            "https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json"; then
            echo "âœ… Magnetic field data downloaded successfully"
          else
            echo "âš ï¸ Magnetic field data fetch failed"
          fi
          
          # Update heartbeat log with fresh data
          echo "ðŸ“ Updating CME heartbeat log..."
          python scripts/cme_heartbeat_logger.py \
            --plasma data/ace_plasma_latest.json \
            --mag data/ace_mag_latest.json
          
          echo "âœ… Fresh data fetch complete"
      
      - name: Generate hourly summary
        run: python scripts/generate_hourly_summary.py
      
      - name: Commit summary and data
        run: |
          git config user.name "LUFT Data Bot"
          git config user.email "data@luft.local"
          git pull --rebase origin main --autostash || true
          git add reports/HOURLY_SUMMARY.md data/cme_heartbeat_log_*.csv || true
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "ðŸ¤– Hourly summary update with fresh data - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary report
        run: |
          echo "### ðŸ“‹ Hourly Summary Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`reports/HOURLY_SUMMARY.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get file size
          SIZE=$(stat -c%s reports/HOURLY_SUMMARY.md)
          SIZE_KB=$(echo "scale=2; $SIZE/1024" | bc)
          echo "**Size:** ${SIZE_KB} KB (target: <5KB)" >> $GITHUB_STEP_SUMMARY
          
          if (( $(echo "$SIZE_KB < 5" | bc -l) )); then
            echo "**Status:** âœ… Within size limit" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âš ï¸ Exceeds 5KB limit" >> $GITHUB_STEP_SUMMARY
          fi

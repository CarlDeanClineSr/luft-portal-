name: Hourly Summary Update

on:
  schedule:
    - cron: '0 * * * *'  # Every hour on the hour
    - cron: '*/15 * * * *'  # Every 15 minutes for more frequent updates (as requested)
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [main]
    paths:
      - 'data/cme_heartbeat_log_*.csv'
      - 'reports/meta_intelligence/**'

permissions:
  contents: write

jobs:
  update-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Generate hourly summary
        run: python scripts/generate_hourly_summary.py
      
      - name: Commit summary
        run: |
          git config user.name "LUFT Data Bot"
          git config user.email "data@luft.local"
          git pull --rebase origin main --autostash || true
          git add reports/HOURLY_SUMMARY.md
          git diff --quiet && git diff --staged --quiet || \
            git commit -m "ðŸ¤– Hourly summary update - $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary report
        run: |
          echo "### ðŸ“‹ Hourly Summary Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`reports/HOURLY_SUMMARY.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get file size
          SIZE=$(stat -c%s reports/HOURLY_SUMMARY.md)
          SIZE_KB=$(echo "scale=2; $SIZE/1024" | bc)
          echo "**Size:** ${SIZE_KB} KB (target: <5KB)" >> $GITHUB_STEP_SUMMARY
          
          if (( $(echo "$SIZE_KB < 5" | bc -l) )); then
            echo "**Status:** âœ… Within size limit" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âš ï¸ Exceeds 5KB limit" >> $GITHUB_STEP_SUMMARY
          fi

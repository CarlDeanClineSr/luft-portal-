name: Capsule Index Job - Master Manifest & Dashboard

on:
  workflow_dispatch:

concurrency:
  group: capsule-index
  cancel-in-progress: true

jobs:
  generate-index-and-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jinja2

      - name: Run capsule index job
        run: |
          echo "Running capsule index job..."
          python scripts/capsule_index_job.py

      - name: Run dashboard generator
        run: |
          echo "Running dashboard generator..."
          python scripts/generate_dashboard.py

      - name: Verify generated files
        run: |
          echo "Verifying generated files..."
          ls -al docs || true
          if [ -s "docs/manifest_master_index.yaml" ]; then
            echo "✅ docs/manifest_master_index.yaml exists and is non-empty"
          else
            echo "❌ docs/manifest_master_index.yaml missing or empty"; exit 1
          fi
          if [ -s "docs/manifest_dashboard.html" ]; then
            echo "✅ docs/manifest_dashboard.html exists and is non-empty"
          else
            echo "❌ docs/manifest_dashboard.html missing or empty"; exit 1
          fi

      - name: Configure Git
        run: |
          git config --local user.name "LUFT-bot"
          git config --local user.email "auto@luft-portal"

      - name: Commit changes (if any)
        run: |
          git add docs/manifest_master_index.yaml docs/manifest_dashboard.html
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Capsule Index: Auto-update $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "Committed changes."
          fi

      - name: Push to main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure we are on main branch
          git fetch origin main
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          if [ "$CURRENT_BRANCH" != "main" ]; then
            git checkout main
          fi
          
          # Pull latest changes to avoid conflicts (rebase strategy with autostash)
          
          # Only push if there are commits ahead
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push origin HEAD:main
            echo "✅ Pushed changes to main."
          else
            echo "No new commits to push."
          fi

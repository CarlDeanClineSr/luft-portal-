name: REVERT ARK PURGE - Restore All Files

on:
  workflow_dispatch:

jobs:
  revert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Revert the ARK purge commit
        run: |
          # Find the "FLOOD" commit
          FLOOD_COMMIT=$(git log --all --grep="THE FLOOD" --format="%H" | head -1)
          
          if [ -n "$FLOOD_COMMIT" ]; then
            echo "Found ARK purge commit: $FLOOD_COMMIT"
            echo "Reverting it now..."
            
            git config user.name "Recovery Bot"
            git config user.email "recovery@luft.local"
            
            if git revert "$FLOOD_COMMIT" --no-edit; then
              git push
            else
              git revert --abort || true
              FLOOD_PARENT=$(git rev-parse "${FLOOD_COMMIT}^1")
              mapfile -t FLOOD_PATHS < <(git diff --name-only "$FLOOD_PARENT" "$FLOOD_COMMIT")
              if [ ${#FLOOD_PATHS[@]} -eq 0 ]; then
                echo "No changed paths found in FLOOD commit"
                exit 1
              fi
              RESTORE_PATHS=()
              REMOVE_PATHS=()
              for path in "${FLOOD_PATHS[@]}"; do
                if [ -z "$path" ]; then
                  continue
                fi
                if git cat-file -e "$FLOOD_PARENT:$path" 2>/dev/null; then
                  RESTORE_PATHS+=("$path")
                else
                  REMOVE_PATHS+=("$path")
                fi
              done
              if [ ${#RESTORE_PATHS[@]} -gt 0 ]; then
                git restore --source "$FLOOD_PARENT" --staged --worktree -- "${RESTORE_PATHS[@]}"
              fi
              if [ ${#REMOVE_PATHS[@]} -gt 0 ]; then
                git rm -f --ignore-unmatch -- "${REMOVE_PATHS[@]}"
              fi
              if git diff --cached --quiet; then
                echo "No restoration changes detected (already restored)."
                exit 0
              fi
              git commit -m "RESTORE: Recover files from pre-FLOOD snapshot"
              git push
            fi
            
            echo "=== REVERT COMPLETE ==="
            echo "Your files should be restored now"
          else
            echo "Could not find the FLOOD commit"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

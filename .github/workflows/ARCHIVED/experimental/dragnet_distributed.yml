name: Dragnet Distributed Survey

on:
  workflow_dispatch:
    inputs:
      total_targets:
        description: 'Total number of stars to scan'
        required: true
        default: '100000'
      batch_size:
        description: 'Stars per worker job'
        required: true
        default: '1000'

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      n_jobs: ${{ steps.set-matrix.outputs.n_jobs }}
    steps:
      - id: set-matrix
        run: |
          TOTAL=${{ inputs.total_targets }}
          BATCH=${{ inputs.batch_size }}
          N_JOBS=$((TOTAL / BATCH))
          if [ $N_JOBS -gt 256 ]; then N_JOBS=256; BATCH=$((TOTAL / N_JOBS)); fi
          MATRIX=$(seq 0 $((N_JOBS - 1)) | jq -R . | jq -s -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "n_jobs=$N_JOBS" >> $GITHUB_OUTPUT

  dragnet-scan:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        job_id: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install skypatrol astroquery astropy lightkurve numpy pandas
      - run: |
          python3 dragnet_distributed_worker.py \
            --job-id ${{ matrix.job_id }} \
            --total-targets ${{ inputs.total_targets }} \
            --batch-size ${{ inputs.batch_size }} \
            --n-jobs ${{ needs.generate-matrix.outputs.n_jobs }} \
            --output data/dragnet_distributed/job_${{ matrix.job_id }}.json
      - uses: actions/upload-artifact@v4
        with:
          name: dragnet-job-${{ matrix.job_id }}
          path: data/dragnet_distributed/job_${{ matrix.job_id }}.json

  aggregate-results:
    needs: [generate-matrix, dragnet-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4.1.3
        with:
          path: data/dragnet_distributed/artifacts
      - run: python3 scripts/aggregate_dragnet_results.py --input-dir data/dragnet_distributed/artifacts --output reports/dragnet_survey_$(date +%Y%m%d_%H%M%S).json
      - uses: actions/upload-artifact@v4
        with:
          name: dragnet-survey-complete
          path: reports/dragnet_survey_*.json

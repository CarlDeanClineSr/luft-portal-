name: Build Papers (PDF)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 1. INSTALL DEPENDENCIES (Enhanced for Greek/Math Fonts)
    - name: Install LaTeX and Pandoc
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-science texlive-latex-extra lmodern

    # 2. RUN THE BUILDER
    - name: Build PDFs
      run: |
        chmod +x tools/build_paper_pdf.sh
        bash tools/build_paper_pdf.sh

    # 3. IMPERIAL LOCKDOWN SEQUENCE (Crash Proof)
    - name: Imperial Commit & Push
      run: |
        # Identity
        git config --local user.email "action@github.com"
        git config --local user.name "Imperial Bot"
        
        # CAPTURE (Stage the PDFs first)
        git add papers/*.pdf
        git add .
        
        # SAVE (Commit locally)
        git commit -m "Imperial PDF Build: Chi 0.15 [skip ci]" || echo "No changes to commit"
        
        # SYNC (Safe Pull)
        git pull origin main --rebase
        
        # UPLOAD
        git push origin main
